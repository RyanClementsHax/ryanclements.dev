name: CI

on:
  pull_request:
    branches: [main]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: restore cache dependencies
        uses: actions/cache@v2
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: install
        run: yarn install --frozen-lockfile --check-files
        # cache the working directory so we can use it in other jobs without having to checkout and install
      - uses: actions/cache@v2
        with:
          path: ./**
          key: ${{ github.sha }}
  lint:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: restore source code
        uses: actions/cache@v2
        with:
          path: ./**
          key: ${{ github.sha }}
      - run: yarn lint:all
  test:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: restore source code
        uses: actions/cache@v2
        with:
          path: ./**
          key: ${{ github.sha }}
      - run: yarn test
  type_check:
    name: type check
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: restore source code
        uses: actions/cache@v2
        with:
          path: ./**
          key: ${{ github.sha }}
      - run: yarn type-check
  # lighthouse:
  #   runs-on: ubuntu-latest
  #   needs: checkout
  #   steps:
  #     - name: wait for deploy preview
  #       uses: jakepartusch/wait-for-netlify-action@v1
  #       id: netlify
  #       with:
  #         site_name: 'practical-mirzakhani-23ef99'
  #         max_timeout: 600 # 10min
  #     # workaround to make sure that any additional commits after opening the pull request get deployed before running lighthouse
  #     - name: ensure deploy preview updated
  #       uses: fountainhead/action-wait-for-check@v1.0.0
  #       with:
  #         token: ${{ secrets.LIGHTHOUSE_CHECK_GITHUB_ACCESS_TOKEN }}
  #         ref: ${{ github.event.pull_request.head.sha || github.sha }}
  #         # There is no reason why we are waiting on this check specifically, we just need to choose one (I think...)
  #         checkName: 'Pages changed - practical-mirzakhani-23ef99'
  #     - name: restore source code
  #       uses: actions/cache@v2
  #       with:
  #         path: ./**
  #         key: ${{ github.sha }}
  #     - name: make artifact directory
  #       run: mkdir /tmp/artifacts
  #     - name: audit deploy preview
  #       uses: foo-software/lighthouse-check-action@master
  #       with:
  #         accessToken: ${{ secrets.LIGHTHOUSE_CHECK_GITHUB_ACCESS_TOKEN }}
  #         urls: ${{ steps.netlify.outputs.url }}
  #         outputDirectory: /tmp/artifacts
  #         emulatedFormFactor: all
  #         overridesJsonFile: ./lighthouse.json
  #     - name: upload audit report
  #       uses: actions/upload-artifact@master
  #       with:
  #         name: Lighthouse reports
  #         path: /tmp/artifacts
